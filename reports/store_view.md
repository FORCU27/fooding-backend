# 지금 보고 있어요 기능

## 1. 개요

"지금 N명이 함께 보고 있어요"와 같이, 사용자가 상점 상세 페이지를 조회할 때 실시간으로 해당 상점을 보고 있는 다른 사용자의 수를 표시하는 기능의 기술적인 결정과 구현 내용에 대해 설명합니다.

## 2. 기술 스택 선정: Redis

### 왜 Redis를 사용했는가?

- **실시간 성(Real-time) 요구사항**:
    - 짧은 시간내에 발생한 이벤트를 집계하여 사용자에게 보여주는 것이 핵심입니다.
    - 디스크 기반의 RDBMS과 비교하여 In-memory 데이터베이스인 Redis의 매우 빠른 읽기/쓰기 속도가 실시간성 요구사항을 충족하기에 최적입니다.

- **DB 부하 감소**:
  - 상점 조회 이벤트
    - 매우 빈번하게 발생할 수 있는 데이터
    - 영속적으로 보관할 필요 없는 데이터
  - 휘발성 데이터 처리에 적합한 Redis를 사용할 근거를 확보했습니다.


- **기존 인프라 활용**:  
  - 프로젝트에서 이미 Reds를 다른 용도(캐싱)으로 사용 중입니다.
    ⇒ 추가적인 인프라 구축 비용 없이 기존 구성된 Redis 사용 가능합니다.

## 3. Redis 자료구조: Set

### 왜 Set을 사용했는가?

- **중복 없는 순수 방문자 수 집계**:  
  - 특정 시간 동안 한 명의 사용자가 여러 번 상점을 조회하더라도, "보고 있는 사람"은 1명으로 집계되어야 합니다.
  - Redis의 `Set` 자료구조는 **중복된 값을 허용하지 않는** 특성을 가지고 있습니다.
- `RedisStoreViewRepository.java`의 `addView` 메소드를 보면 `redisTemplate.opsForSet().add(key, viewerKey)`를 통해 `viewerKey`를 Set에 추가합니다.
  - 동일한 `viewerKey`가 다시 추가되더라도 Set의 멤버는 변경되지 않으므로, 자연스럽게 중복 조회를 제거하고 순수한 방문자 수를 관리할 수 있습니다.
  - 조회 인원수를 가져올 때는 `opsForSet().size(key)`를 사용하여 Set에 포함된 원소의 개수(cardinality)를 `O(1)` 시간 복잡도로 매우 빠르게 얻을 수 있습니다.

## 4. 구현 상세 및 근거

### Key 설계

- 각 상점별로 독립적인 조회 수를 집계하기 위해 `store:view:{storeId}` 형태의 Key를 사용합니다.
- 이를 통해 특정 상점 ID(`storeId`)에 대한 조회 정보만을 효율적으로 관리할 수 있습니다.

### 5분 TTL(Time-To-Live) 설정

- `STORE_VIEW_TTL = Duration.ofMinutes(5)`
- 이 기능의 요구사항은 "역대 총 조회 수"가 아닌, "**지금** 보고 있는 사람 수"를 대략적으로 보여주는 것입니다.  
  `addView` 메소드에서 Set에 데이터를 추가한 후, `redisTemplate.expire(key, STORE_VIEW_TTL)`을 호출하여 해당 Key에 5분의 만료 시간을 설정합니다.
- 5분 동안 아무도 해당 상점을 조회하지 않으면 Redis의 Key가 자동으로 삭제되어 리소스를 효율적으로 사용할 수 있습니다.
- 결과적으로, 이 기능은 **"최근 5분 동안 해당 상점을 조회한 순수 방문자 수"** 를 의미하게 되며, 이는 "실시간 조회 인원"이라는 요구사항을 충족하는 합리적인 근사치라고 판단했습니다.

### 사용자 구분 처리

- **로그인 사용자**:  
  `user:{viewerId}` 형태로 `viewerKey`를 생성합니다.   
  이를 통해 동일한 사용자가 5분 내에 여러 번 조회해도 1명으로만 집계됩니다.

- **비로그인 사용자**:  
  `unknown:{LocalDateTime.now()}` 형태로 `viewerKey`를 생성합니다.  
  비로그인 사용자는 식별할 ID가 없으므로, 조회 시점의 타임스탬프를 이용해 매번 고유한 값으로 취급합니다.  
  이는 비로그인 사용자가 페이지를 새로고침할 때마다 카운트가 올라갈 수 있음을 의미하지만, 익명 사용자를 집계하기 위한 간단하고 효율적인 트레이드오프라 판단했습니다..

## 5. 결론

상점 실시간 조회 수 기능은 Redis의 Set 자료구조와 TTL을 활용하여 주 데이터베이스에 부하를 주지 않으면서 실시간 성 요구사항을 효과적으로 만족시키는 방식으로 구현했습니다. 이 방식은 정확한 수치보다는 "현재 인기"를 보여주는 근사치를 제공하는 데 초점을 맞추었으며, 이는 서비스의 목적에 부합하는 효율적이고 확장 가능한 해결책이라 판단했습니다.
